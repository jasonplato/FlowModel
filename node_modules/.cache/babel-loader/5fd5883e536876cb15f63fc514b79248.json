{"remainingRequest":"/Users/xufei/Desktop/FlowModel/node_modules/babel-loader/lib/index.js!/Users/xufei/Desktop/FlowModel/node_modules/eslint-loader/index.js??ref--13-0!/Users/xufei/Desktop/FlowModel/src/graph/action.js","dependencies":[{"path":"/Users/xufei/Desktop/FlowModel/src/graph/action.js","mtime":1653708835726},{"path":"/Users/xufei/Desktop/FlowModel/node_modules/cache-loader/dist/cjs.js","mtime":1653708689072},{"path":"/Users/xufei/Desktop/FlowModel/node_modules/babel-loader/lib/index.js","mtime":1653708688758},{"path":"/Users/xufei/Desktop/FlowModel/node_modules/eslint-loader/index.js","mtime":1653708690128}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZm9yLWVhY2giOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5uYW1lIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubWFwIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubnVtYmVyLmNvbnN0cnVjdG9yIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvciI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIjsKaW1wb3J0IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyIGZyb20gIi9Vc2Vycy94dWZlaS9EZXNrdG9wL0Zsb3dNb2RlbC9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiL1VzZXJzL3h1ZmVpL0Rlc2t0b3AvRmxvd01vZGVsL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVDbGFzcyI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiL1VzZXJzL3h1ZmVpL0Rlc2t0b3AvRmxvd01vZGVsL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCB7IFRva2VuIH0gZnJvbSAiLi90b2tlbiI7CmltcG9ydCB7IHBvdywgZGl2aWRlLCBzdWJ0cmFjdCwgY2hhaW4gfSBmcm9tICdtYXRoanMnOwppbXBvcnQgeyBOb25OZWdhdGl2ZSwgU3RhbmRhcmROdW0gfSBmcm9tICIuLi91dGlscy9udW1iZXJVdGlsIjsKaW1wb3J0IHsgbWFwSW5pdCB9IGZyb20gIi4uL3V0aWxzL21hcEluaXQiOwpleHBvcnQgdmFyIEFjdGlvbiA9IGZ1bmN0aW9uIEFjdGlvbigpIHsKICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgQWN0aW9uKTsKCiAgLy8gc3Rha2VMYWJlbElETWFwIDxrZXk6IG5vZGVMYWJlbCwgdmFsdWU6IG5vZGVJRD4gOiBzdGFrZSDoioLngrnnmoQgbGFiZWwo5Lqk5LqS6aG16Z2i5Y+v55Sx55So5oi36Ieq5a6a5LmJ55qE5paH5pys5ZCNKSDkuI4gaWQg5pig5bCE6KGoCiAgdGhpcy5zdGFrZUxhYmVsSURNYXAgPSBuZXcgTWFwKCk7IC8vIHN0YWtlTGFiZWxJRE1hcCA8a2V5OiBub2RlTGFiZWwsIHZhbHVlOiBub2RlSUQ+IDogdW5zdGFrZSDoioLngrnnmoQgbGFiZWwg5LiOIGlkIOaYoOWwhOihqAoKICB0aGlzLnVuc3Rha2VMYWJlbElETWFwID0gbmV3IE1hcCgpOyAvLyBzdGFrZUxhYmVsSURNYXAgPGtleTogbm9kZUxhYmVsLCB2YWx1ZTogbm9kZUlEPiA6IHZlc3Qg6IqC54K555qEIGxhYmVsIOS4jiBpZCDmmKDlsITooagKCiAgdGhpcy52ZXN0TGFiZWxJRE1hcCA9IG5ldyBNYXAoKTsKfTsKZXhwb3J0IHZhciBTdGFrZSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgLy8gY29uc3RydWN0b3IKICAvLyBwYXJhbXM6CiAgLy8gICAgICBzdGFrZVRva2VuOiAiQXBleCIsCiAgLy8gICAgICByZXdhcmRUb2tlbjogImVzQXBleCIKICAvLyAgICAgIHJld2FyZFBvbGljeSB7CiAgLy8gICAgICAgICAgQmlnSW50IHJld2FyZFRvdGFsOwogIC8vICAgICAgICAgIGludCByZXdhcmRMaWZldGltZTsKICAvLyAgICAgICAgICBpbnQgcmV3YXJkUmVmcmVzaFBlcmlvZDsKICAvLyAgICAgICAgICBmbG9hdCByZXdhcmREZWZhY3RvcjsKICAvLyAgICAgIH0sCiAgLy8gICAgICBzdGFrZUFtb3VudDogWwogIC8vICAgICAgICAgIHsgbmFtZTogIlRlYW0iLCBwcm9wOiAwLCBjbGFzczogInRlYW0tc2xpZGVyIiB9LAogIC8vICAgICAgICAgIHsgbmFtZTogIkludmVzdG9yIiwgcHJvcDogMCwgY2xhc3M6ICJpbnZlc3Rvci1zbGlkZXIiIH0sCiAgLy8gICAgICAgICAgeyBuYW1lOiAiQWR2aXNvciIsIHByb3A6IDAsIGNsYXNzOiAiYWR2aXNvci1zbGlkZXIiIH0sCiAgLy8gICAgICAgICAgeyBuYW1lOiAiRm91bmRhdGlvbiIsIHByb3A6IDAsIGNsYXNzOiAiZm91bmRhdGlvbi1zbGlkZXIiIH0sCiAgLy8gICAgICAgICAgeyBuYW1lOiAiQ29tbXVuaXR5IiwgcHJvcDogMCwgY2xhc3M6ICJjb21tdW5pdHktc2xpZGVyIiB9LAogIC8vICAgICAgXSwKICAvLyBUT0RPIHJld2FyZFRva2VuLCBzdGFrZVRva2Ug5piv5ZCm5b+F6KaB77yfCiAgZnVuY3Rpb24gU3Rha2UobGFiZWwsIHJld2FyZFBvbGljeSwgc3Rha2VBbW91bnQpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFN0YWtlKTsKCiAgICAvLyBsYWJlbDog55So5oi35Zyo5YmN56uv5Lqk5LqS6aG16Z2i5Li66IqC54K56Ieq5a6a5LmJ55qE5ZCN5a2XCiAgICB0aGlzLmxhYmVsID0gbGFiZWw7IC8vIHN0YWtlVG9rZW46IHN0YWtlIOaUr+aMgeeahOi0qOaKvOW4geenjQogICAgLy8gcmV3YXJkVG9rZW46IHN0YWtlIOeahOi0qOaKvOWlluWKseW4geenjQogICAgLy8gcmV3YXJkVG90YWw6IHN0YWtlIOS6p+eUn+eahOi0qOaKvOWlluWKseW4geaAu+mHjwoKICAgIHRoaXMucmV3YXJkVG90YWwgPSBOdW1iZXIocmV3YXJkUG9saWN5LnJld2FyZFRvdGFsKTsgLy8gcmV3YXJkTGlmZXRpbWU6IHN0YWtlIOS6p+eUn+i0qOaKvOWlluWKseeahOaAu+aXtumVvwoKICAgIHRoaXMucmV3YXJkTGlmZXRpbWUgPSBOdW1iZXIocmV3YXJkUG9saWN5LnJld2FyZExpZmV0aW1lKTsgLy8gcmV3YXJkUmVmcmVzaFBlcmlvZDogc3Rha2Ug5Lqn55Sf6LSo5oq85aWW5Yqx55qE5ZGo5pyfCgogICAgdGhpcy5yZXdhcmRSZWZyZXNoUGVyaW9kID0gTnVtYmVyKHJld2FyZFBvbGljeS5yZXdhcmRSZWZyZXNoUGVyaW9kKTsgLy8gcmV3YXJkRGVmYWN0b3I6IHN0YWtlIOi0qOaKvOWlluWKseeahOihsOWHj+WboOWtkAoKICAgIHRoaXMucmV3YXJkRGVmYWN0b3IgPSBOdW1iZXIocmV3YXJkUG9saWN5LnJld2FyZERlZmFjdG9yKTsgLy8gc3Rha2VBbW91bnQ6IHN0YWtlIOeahOaVsOmHjyjku6Xnmb7liIbmr5TnmoTlvaLlvI8pCiAgICAvLyBFeGFtcGxlOiB7IlRlYW0iOiAwLjgsICJDb21tdW5pdHkiOiAwLjh9CgogICAgdGhpcy5zdGFrZUFtb3VudCA9IG5ldyBNYXAoKTsgLy8gVE9ETyBpblBvb2xBbW91bnQg55u45YWz5Y+C5pWw5pqC5pe25LiN6ZyA6KaB5LqG77yM5Zug5Li65LulIFRva2VuIOiKgueCueeahCBzdGFrZWRBbW91bnQg5Li65YeGCiAgICAvLyBpblBvb2xBbW91bnQ6IHN0YWtlIOi0qOaKvOaxoOS4reW3sue7j+acieeahOi0qOaKvOW4geaVsOmHjwogICAgLy8gRXhhbXBsZTogeyJUZWFtIjogMTAwLCAiQ29tbXVuaXR5IjogMTAwfQogICAgLy8gdGhpcy5pblBvb2xBbW91bnQgPSBuZXcgTWFwKCk7CiAgICAvLyBpblBvb2xBbW91bnREZWx0YTogc3Rha2Ug6LSo5oq85rGg5Lit5bey57uP5pyJ55qE6LSo5oq85biB5pWw6YePIOWinumHj+aVsOaNrgogICAgLy8gdGhpcy5pblBvb2xBbW91bnREZWx0YSA9IG5ldyBNYXAoKTsKICAgIC8vIGluUG9vbEFtb3VudFRvdGFsOiBzdGFrZSDotKjmirzmsaDkuK3lt7LmnInnmoTotKjmirzluIHmgLvph48KICAgIC8vIHRoaXMuaW5Qb29sQW1vdW50VG90YWwgPSAwOwogICAgLy8gcmV3YXJkQWxsb2NhdGVkOiBzdGFrZSDlt7Lnu4/kuqfnlJ/nmoTlpZblirHliIbphY0KICAgIC8vIEV4YW1wbGU6IHsiVGVhbSI6IDEwMDAwLCAiQ29tbXVuaXR5IjogMTAwMDB9CgogICAgdGhpcy5yZXdhcmRBbGxvY2F0ZWQgPSBuZXcgTWFwKCk7IC8vIHJld2FyZEFsbG9jYXRlZERlbHRhOiBzdGFrZSDlt7Lnu4/kuqfnlJ/nmoTlpZblirHliIbphY0g5aKe6YeP5pWw5o2uCgogICAgdGhpcy5yZXdhcmRBbGxvY2F0ZWREZWx0YSA9IG5ldyBNYXAoKTsgLy8gcmV3YXJkQWxsb2NhdGVkVG90YWw6IHN0YWtlIOW3sue7j+S6p+eUn+eahOWlluWKseaAu+mHjwoKICAgIHRoaXMucmV3YXJkQWxsb2NhdGVkVG90YWwgPSBOdW1iZXIoMCk7IC8vIHJld2FyZExpc3Q6IOS/neWtmOS6huavj+WkqeWPr+S7pemHiuaUvueahCByZXdhcmQg6YePCgogICAgdGhpcy5yZXdhcmRMaXN0ID0gdGhpcy5jYWxjdWxhdGVSZXdhcmRMaXN0KHRoaXMucmV3YXJkVG90YWwsIHRoaXMucmV3YXJkTGlmZXRpbWUsIHRoaXMucmV3YXJkUmVmcmVzaFBlcmlvZCwgdGhpcy5yZXdhcmREZWZhY3Rvcik7IC8vIHJld2FyZElkeDog6K6w5b2V5b2T5YmN5aWW5Yqx6YeK5pS+55qE6L+b5bqmCgogICAgdGhpcy5yZXdhcmRJZHggPSBOdW1iZXIoMCk7CiAgICBzdGFrZUFtb3VudC5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgIC8vIOiOt+WPliBzdGFrZUFtb3VudCDmlbDmja4KICAgICAgX3RoaXMuc3Rha2VBbW91bnQuc2V0KGVsZW1lbnQubmFtZSwgTnVtYmVyKGVsZW1lbnQucHJvcCkgLyAxMDApOyAvLyBpblBvb2xBbW91bnQg6KGo56S65bey57uP6LSo5oq85Zyo5rGg5a2Q6YeM55qE5pWw6YePCiAgICAgIC8vIHRoaXMuaW5Qb29sQW1vdW50LnNldChlbGVtZW50Lm5hbWUsIDApOwogICAgICAvLyB0aGlzLmluUG9vbEFtb3VudERlbHRhLnNldChlbGVtZW50Lm5hbWUsIDApOwogICAgICAvLyByZXdhcmRBbGxvY2F0ZWQg6KGo56S65bey57uP5YiG6YWN55qE5pS255uKCgoKICAgICAgX3RoaXMucmV3YXJkQWxsb2NhdGVkLnNldChlbGVtZW50Lm5hbWUsIE51bWJlcigwKSk7CgogICAgICBfdGhpcy5yZXdhcmRBbGxvY2F0ZWREZWx0YS5zZXQoZWxlbWVudC5uYW1lLCBOdW1iZXIoMCkpOwogICAgfSk7CiAgICBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpTdGFrZTogcmV3YXJkIHRvdGFsOiIsIHRoaXMucmV3YXJkVG90YWwpOwogIH0gLy8g5omn6KGM5rWL566X6YC76L6RCgoKICBfY3JlYXRlQ2xhc3MoU3Rha2UsIFt7CiAgICBrZXk6ICJydW4iLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJ1bihwcmVOb2RlLCBjdXJEYXkpIHsKICAgICAgLy8g5aaC5p6c5rKh5pyJ5YmN5bqP6IqC54K577yM5YiZ5LiN5Lya5omn6KGM5rWL566X6YC76L6RCiAgICAgIGlmIChwcmVOb2RlID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8g5b2T5rGg5a2Q55qE5aWW5Yqx6K6h5YiS5bey57uP57uT5p2f77yM5oiW6ICF5YiG6YWN5Ye65Y6755qE5aWW5Yqx5bey57uP6L6+5Yiw5Yid5aeL6K6+572u55qE5aWW5Yqx5oC76aKd5pe277yM5LiN5YaN5omn6KGM5b2T5YmNIHN0YWtlIOeahOa1i+eul+mAu+i+kQoKCiAgICAgIGlmICh0aGlzLnJld2FyZElkeCA+PSB0aGlzLnJld2FyZExpZmV0aW1lIHx8IHRoaXMucmV3YXJkQWxsb2NhdGVkVG90YWwgPj0gdGhpcy5yZXdhcmRUb3RhbCkgewogICAgICAgIC8vIGxvZyDmj5DnpLogc3Rha2Ug5bey5LiN5Lya57un57ut6YeK5pS+5aWW5YqxCiAgICAgICAgLy8gVE9ETyDmioogc3Rha2Ug5rGg5a2Q6YeM5bey5pyJ55qEIHN0YWtlZEFtb3VudCDph4rmlL7lh7rljrvmiJDkuLogZnJlZU1vbmV5LiDlpoLkvZXpgb/lhY0gVW5zdGFrZSDpgqPovrnnmoTmk43kvZzph43lpI3lj5blh7rvvJ8KICAgICAgICAvLyBpZiAocHJlTm9kZS5jb25zdHJ1Y3RvciA9PT0gVG9rZW4pIHsKICAgICAgICAvLyAgICAgZm9yIChsZXQgaXRlbSBvZiBwcmVOb2RlLnN0YWtlZEFtb3VudCkgewogICAgICAgIC8vICAgICAgICAgaWYgKGl0ZW1bMV0gPD0gMCkKICAgICAgICAvLyAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAvLyAgICAgICAgIC8vIOS7juWJjeW6jyB0b2tlbiDoioLngrnkuK3lh4/ljrsgc3Rha2Ug55qE5YWo6YOo5pWw6YePCiAgICAgICAgLy8gICAgICAgICBsZXQgc3Rha2VEZWx0YSA9IHByZU5vZGUuc3Rha2VkQW1vdW50RGVsdGEuZ2V0KGl0ZW1bMF0pOwogICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6U3Rha2U6IHN0YWtlQW1vdW50IG1pbnVzOiIsIGl0ZW1bMV0pOwogICAgICAgIC8vICAgICAgICAgc3Rha2VEZWx0YSAtPSBpdGVtWzFdOwogICAgICAgIC8vICAgICAgICAgcHJlTm9kZS5zdGFrZWRBbW91bnREZWx0YS5zZXQoaXRlbVswXSwgc3Rha2VEZWx0YSk7CiAgICAgICAgLy8gICAgICAgICAvLyDlvoDliY3luo8gdG9rZW4g6IqC54K555qEIGZyZWVNb25leURlbHRhIOWKoOS4iiBzdGFrZSDnmoTlhajpg6jmlbDph48KICAgICAgICAvLyAgICAgICAgIGxldCBmcmVlTW9uZXlEZWx0YSA9IHByZU5vZGUuZnJlZU1vbmV5RGVsdGEuZ2V0KGl0ZW1bMF0pOwogICAgICAgIC8vICAgICAgICAgZnJlZU1vbmV5RGVsdGEgKz0gaXRlbVsxXTsKICAgICAgICAvLyAgICAgICAgIHByZU5vZGUuZnJlZU1vbmV5RGVsdGEuc2V0KGl0ZW1bMF0sIGZyZWVNb25leURlbHRhKTsKICAgICAgICAvLyAgICAgfQogICAgICAgIC8vIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChwcmVOb2RlLmNvbnN0cnVjdG9yID09PSBUb2tlbikgewogICAgICAgIC8vIFRPRE8gW0RvbmUsIFN0YWtlQW1vdW50IOe7n+S4gOaUvuWcqCBUb2tlbiDoioLngrnkuK0uIFN0YWtlIOWSjCBVbnN0YWtlIOaTjeS9nOmDveWfuuS6jiBUb2tlbiDoioLngrnnmoQgU3Rha2VBbW91bnQg5pWw5o2uLCDkvYbov5jkuI3noa7lrprlrZjlnKjku4DkuYjpl67pophdIFN0YWtlIOWmguS9leaEn+efpeWIsCBVbnN0YWtlIOaTjeS9nOeahOW9seWTjQogICAgICAgIC8vIHRoaXMuaW5Qb29sQW1vdW50ID0gcHJlTm9kZS5zdGFrZWRBbW91bnQ7CiAgICAgICAgLy8gdGhpcy5pblBvb2xBbW91bnREZWx0YSA9IHByZU5vZGUuc3Rha2VkQW1vdW50RGVsdGE7CiAgICAgICAgLy8gdGhpcy5pblBvb2xBbW91bnRUb3RhbCA9IHByZU5vZGUuc3Rha2VkVG90YWw7CiAgICAgICAgLy8gY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6cHJlIE5vZGUgaXM6ICIsIHByZU5vZGUuc3ltYm9sKTsKICAgICAgICAvLyDlvZPlpKnliqDlhaUgc3Rha2Ug5rGg5a2Q5Lit55qEIHRva2VuIOmHjwogICAgICAgIHZhciBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcihwcmVOb2RlLnN0YWtlZEFtb3VudERlbHRhKSwKICAgICAgICAgICAgX3N0ZXA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKF9pdGVyYXRvci5zKCk7ICEoX3N0ZXAgPSBfaXRlcmF0b3IubigpKS5kb25lOykgewogICAgICAgICAgICB2YXIgX2l0ZW0gPSBfc3RlcC52YWx1ZTsKCiAgICAgICAgICAgIGlmIChwcmVOb2RlLmZyZWVNb25leS5oYXMoX2l0ZW1bMF0pKSB7CiAgICAgICAgICAgICAgLy8gVE9ETyBbRG9uZV0g5aaC5p6c5aKe6YeP5pWw5o2u5Li6IDDvvIzlsLHot7Pov4cKICAgICAgICAgICAgICB2YXIgX2RlbHRhID0gU3RhbmRhcmROdW0ocHJlTm9kZS5mcmVlTW9uZXkuZ2V0KF9pdGVtWzBdKSAqIHRoaXMuc3Rha2VBbW91bnQuZ2V0KF9pdGVtWzBdKSk7CgogICAgICAgICAgICAgIGlmIChfZGVsdGEgPD0gMC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICBfaXRlbVsxXSArPSBfZGVsdGE7IC8vIOaKiuS4iui/sOW9k+WkqeWKoOWFpSBzdGFrZSDmsaDlrZDnmoQgdG9rZW4g6YeP57Sv5Yqg5Yiw5YmN5bqP6IqC54K555qEIHN0YWtlZEFtb3VudCDkuIoKCiAgICAgICAgICAgICAgcHJlTm9kZS5zdGFrZWRBbW91bnREZWx0YS5zZXQoX2l0ZW1bMF0sIF9pdGVtWzFdKTsgLy8g5oqK5LiK6L+w5b2T5aSp5Yqg5YWlIHN0YWtlIOaxoOWtkOeahCB0b2tlbiDku47liY3luo/oioLngrnkuK3lh4/ljrsKCiAgICAgICAgICAgICAgcHJlTm9kZS5mcmVlTW9uZXlEZWx0YS5zZXQoX2l0ZW1bMF0sIHByZU5vZGUuZnJlZU1vbmV5RGVsdGEuZ2V0KF9pdGVtWzBdKSAtIF9kZWx0YSk7CiAgICAgICAgICAgIH0gLy8gdGhpcy5pblBvb2xBbW91bnREZWx0YS5zZXQoaXRlbVswXSwgaXRlbVsxXSk7CgogICAgICAgICAgfSAvLyDlvZPlpKkgc3Rha2Ug5rGg5a2Q5Lqn55Sf55qE5aWW5Yqx6YePLCDlj6rmnInlvZMgaW5Qb29sQW1vdW50VG90YWwgPiAwIOaXtuaJjeS8muacieWlluWKseWIhumFjQoKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIF9pdGVyYXRvci5mKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAocHJlTm9kZS5zdGFrZWRUb3RhbCA+IDApIHsKICAgICAgICAgIHZhciBjdXJSZXdhcmQgPSB0aGlzLnJld2FyZExpc3RbdGhpcy5yZXdhcmRJZHhdOwogICAgICAgICAgY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6U3Rha2U6IGN1cmVudCByZXdhcmQ6IiwgY3VyUmV3YXJkKTsKCiAgICAgICAgICB2YXIgX2l0ZXJhdG9yMiA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMucmV3YXJkQWxsb2NhdGVkRGVsdGEpLAogICAgICAgICAgICAgIF9zdGVwMjsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjIucygpOyAhKF9zdGVwMiA9IF9pdGVyYXRvcjIubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBpdGVtID0gX3N0ZXAyLnZhbHVlOwogICAgICAgICAgICAgIC8vIFRPRE8gW0RvbmVdIOWinumHj+aVsOaNruWmguaenOS4ujDvvIzlsLHot7Pov4cKICAgICAgICAgICAgICB2YXIgZGVsdGEgPSBTdGFuZGFyZE51bShwcmVOb2RlLnN0YWtlZEFtb3VudC5nZXQoaXRlbVswXSkgLyBwcmVOb2RlLnN0YWtlZFRvdGFsICogY3VyUmV3YXJkKTsKICAgICAgICAgICAgICBpZiAoZGVsdGEgPD0gMC4wKSBjb250aW51ZTsKICAgICAgICAgICAgICBpdGVtWzFdICs9IGRlbHRhOwogICAgICAgICAgICAgIHRoaXMucmV3YXJkQWxsb2NhdGVkRGVsdGEuc2V0KGl0ZW1bMF0sIGl0ZW1bMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yMi5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3IyLmYoKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnJld2FyZElkeCsrOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwcmVOb2RlLmNvbnN0cnVjdG9yID09PSBTdGFrZSkgewogICAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6OnByZSBOb2RlIGlzOiAiLCBwcmVOb2RlLmxhYmVsKTsKICAgICAgfSBlbHNlIGlmIChwcmVOb2RlLmNvbnN0cnVjdG9yID09PSBWZXN0KSB7CiAgICAgICAgY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6cHJlIE5vZGUgaXM6ICIsIHByZU5vZGUubGFiZWwpOwogICAgICB9IGVsc2UgaWYgKHByZU5vZGUuY29uc3RydWN0b3IgPT09IFVuc3Rha2UpIHsKICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpwcmUgTm9kZSBpczogIiwgcHJlTm9kZS5sYWJlbCk7CiAgICAgIH0KICAgIH0gLy8g5omn6KGMIERlbHRhIOaVsOaNruWIsCBDb21taXQg5pWw5o2u55qE5pu05pawCgogIH0sIHsKICAgIGtleTogInVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICAvLyBmb3IgKGxldCBpdGVtIG9mIHRoaXMuaW5Qb29sQW1vdW50KSB7CiAgICAgIC8vICAgICBpdGVtWzFdICs9IHRoaXMuaW5Qb29sQW1vdW50RGVsdGEuZ2V0KGl0ZW1bMF0pOwogICAgICAvLyAgICAgdGhpcy5pblBvb2xBbW91bnQuc2V0KGl0ZW1bMF0sIGl0ZW1bMV0pOwogICAgICAvLyAgICAgdGhpcy5pblBvb2xBbW91bnRUb3RhbCArPSB0aGlzLmluUG9vbEFtb3VudERlbHRhLmdldChpdGVtWzBdKTsKICAgICAgLy8gICAgIHRoaXMuaW5Qb29sQW1vdW50RGVsdGEuc2V0KGl0ZW1bMF0sIDApOwogICAgICAvLyB9CiAgICAgIHZhciBfaXRlcmF0b3IzID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy5yZXdhcmRBbGxvY2F0ZWQpLAogICAgICAgICAgX3N0ZXAzOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKF9pdGVyYXRvcjMucygpOyAhKF9zdGVwMyA9IF9pdGVyYXRvcjMubigpKS5kb25lOykgewogICAgICAgICAgdmFyIGl0ZW0gPSBfc3RlcDMudmFsdWU7CiAgICAgICAgICBpdGVtWzFdID0gTm9uTmVnYXRpdmUoaXRlbVsxXSArIHRoaXMucmV3YXJkQWxsb2NhdGVkRGVsdGEuZ2V0KGl0ZW1bMF0pKTsKICAgICAgICAgIHRoaXMucmV3YXJkQWxsb2NhdGVkLnNldChpdGVtWzBdLCBOdW1iZXIoaXRlbVsxXSkpOwogICAgICAgICAgdGhpcy5yZXdhcmRBbGxvY2F0ZWRUb3RhbCA9IE5vbk5lZ2F0aXZlKHRoaXMucmV3YXJkQWxsb2NhdGVkVG90YWwgKyB0aGlzLnJld2FyZEFsbG9jYXRlZERlbHRhLmdldChpdGVtWzBdKSk7CiAgICAgICAgICB0aGlzLnJld2FyZEFsbG9jYXRlZERlbHRhLnNldChpdGVtWzBdLCBOdW1iZXIoMCkpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgX2l0ZXJhdG9yMy5lKGVycik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgX2l0ZXJhdG9yMy5mKCk7CiAgICAgIH0KCiAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6OlN0YWtlOiByZXdhcmRBbGxvY2F0ZWQ6IiwgdGhpcy5yZXdhcmRBbGxvY2F0ZWQpOwogICAgICBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpTdGFrZTogcmV3YXJkQWxsb2NhdGVkRGVsdGE6IiwgdGhpcy5yZXdhcmRBbGxvY2F0ZWREZWx0YSk7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6OlN0YWtlOiByZXdhcmRBbGxvY2F0ZWRUb3RhbDoiLCB0aGlzLnJld2FyZEFsbG9jYXRlZFRvdGFsKTsKICAgIH0gLy8g6K6h566X5Ye65b2T5aWW5Yqx5oC76YeP5Li6IHRvdGFsQW1vdW50LCBzdGFraW5n5aWW5Yqx5pe26ZW/IHRvdGFsVGltZSwg5aWW5Yqx5Yi35paw5ZGo5pyf5Li6IHBlcmlvZFRpbWUsIOavj+S4quWRqOacn+WlluWKseeahOihsOWHj+ezu+aVsOS4uiBkZWZhY3RvciDnmoTmg4XlhrXkuIvvvIzlrozmlbTnmoTmr4/lpKnlpZblirHph4/liJfooagKICAgIC8vIOS+i+WmgjogWzEwMDAsOTAwLDgxMCwuLi5dLCDmhI/kuLrnrKwx5aSp55qE5aWW5Yqx6YeP5Li6MTAwMCwg56ysMuWkqeeahOWlluWKsemHj+S4ujkwMCwuLi4KCiAgfSwgewogICAga2V5OiAiY2FsY3VsYXRlUmV3YXJkTGlzdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2FsY3VsYXRlUmV3YXJkTGlzdCh0b3RhbEFtb3VudCwgdG90YWxUaW1lLCBwZXJpb2RUaW1lLCBkZWZhY3RvcikgewogICAgICAvLyBUT0RPIFtEb25lXSBjb3JuZXIgY2FzZSDnmoTov5Tlm57lgLzpnIDopoHkv67mlLnkuLogYXJyYXkg57G75Z6LCiAgICAgIGlmICh0b3RhbEFtb3VudCA9PSAwKSB7CiAgICAgICAgcmV0dXJuIFswXTsKICAgICAgfQoKICAgICAgaWYgKHRvdGFsVGltZSA8PSAxKSB7CiAgICAgICAgcmV0dXJuIFt0b3RhbEFtb3VudF07CiAgICAgIH0KCiAgICAgIGlmIChwZXJpb2RUaW1lID09IDApIHsKICAgICAgICByZXR1cm4gW3RvdGFsQW1vdW50XTsKICAgICAgfQoKICAgICAgaWYgKGRlZmFjdG9yID09IDApIHsKICAgICAgICByZXR1cm4gW3RvdGFsQW1vdW50XTsKICAgICAgfQoKICAgICAgdmFyIHBlcmlvZE51bSA9IGRpdmlkZSh0b3RhbFRpbWUsIHBlcmlvZFRpbWUpOwogICAgICB2YXIgZGl2aWRlbmQgPSBzdWJ0cmFjdCgxLCBkZWZhY3Rvcik7CiAgICAgIHZhciBkaXZpc29yID0gc3VidHJhY3QoMSwgcG93KGRlZmFjdG9yLCBwZXJpb2ROdW0pKTsKICAgICAgdmFyIHJlbGVhc2VCYXNlID0gU3RhbmRhcmROdW0oY2hhaW4odG90YWxBbW91bnQpLm11bHRpcGx5KGRpdmlkZW5kKS5kaXZpZGUoZGl2aXNvcikpOwoKICAgICAgaWYgKGRlZmFjdG9yID09IDEuMCkgewogICAgICAgIHJlbGVhc2VCYXNlID0gU3RhbmRhcmROdW0oY2hhaW4odG90YWxBbW91bnQpLmRpdmlkZShwZXJpb2ROdW0pKTsKICAgICAgfQoKICAgICAgdmFyIHJlcyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbFRpbWU7IGkrKykgewogICAgICAgIHZhciBjdXJQZXJpb2QgPSBNYXRoLmZsb29yKGkgLyBwZXJpb2RUaW1lKTsKICAgICAgICB2YXIgdG1wID0gU3RhbmRhcmROdW0ocmVsZWFzZUJhc2UgKiBwb3coZGVmYWN0b3IsIGN1clBlcmlvZCkgLyBwZXJpb2RUaW1lKTsKICAgICAgICByZXMucHVzaCh0bXApOwogICAgICB9CgogICAgICByZXR1cm4gcmVzOwogICAgfSAvLyDlvZPmqKHlnovku47mmoLlgZznirbmgIHph43mlrDlkK/liqjmtYvnrpfml7bvvIznlKjmiLflj6/og73lr7nlj4LmlbDov5vooYzkuobkv67mlLnvvIzmlrDnmoTlj4LmlbDpnIDopoHmm7TmlrDliLDmqKHlnovkuK0KICAgIC8vIOabtOaWsOW3suWtmOWcqOeahCBzdGFrZSDlrp7kvovph4znmoTlj4LmlbAKCiAgfSwgewogICAga2V5OiAic2VsZlVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2VsZlVwZGF0ZShsYWJlbCwgcmV3YXJkUG9saWN5LCBzdGFrZUFtb3VudCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHRoaXMubGFiZWwgPSBsYWJlbDsgLy8gVE9ETyDmmoLkuI3mlK/mjIHlnKjmtYvnrpfkuK3pgJTmm7TmlLkgcmV3YXJkVG90YWzvvIzlm6DkuLogcmV3YXJkTGlzdCDmmK/lnKjmtYvnrpfliJ3lp4vnmoTml7blgJnlsLHorqHnrpflh7rmnaXkuoYKICAgICAgLy8gdGhpcy5yZXdhcmRUb3RhbCA9IE51bWJlcihyZXdhcmRQb2xpY3kucmV3YXJkVG90YWwpOwoKICAgICAgdGhpcy5yZXdhcmRMaWZldGltZSA9IE51bWJlcihyZXdhcmRQb2xpY3kucmV3YXJkTGlmZXRpbWUpOwogICAgICB0aGlzLnJld2FyZFJlZnJlc2hQZXJpb2QgPSBOdW1iZXIocmV3YXJkUG9saWN5LnJld2FyZFJlZnJlc2hQZXJpb2QpOwogICAgICB0aGlzLnJld2FyZERlZmFjdG9yID0gTnVtYmVyKHJld2FyZFBvbGljeS5yZXdhcmREZWZhY3Rvcik7CiAgICAgIHN0YWtlQW1vdW50LmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAvLyDmm7TmlrAgc3Rha2VBbW91bnQg5pWw5o2uCiAgICAgICAgX3RoaXMyLnN0YWtlQW1vdW50LnNldChlbGVtZW50Lm5hbWUsIE51bWJlcihlbGVtZW50LnByb3ApIC8gMTAwKTsKICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3Rha2U7Cn0oKTsKZXhwb3J0IHZhciBVbnN0YWtlID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAvLyBjb25zdHJ1Y3RvcgogIC8vIHBhcmFtczoKICAvLyAgICAgIGNvb2xUaW1lOiAxODAKICAvLyAgICAgIHVuc3Rha2VBbW91bnQ6IFsKICAvLyAgICAgICAgICB7IG5hbWU6ICJUZWFtIiwgcHJvcDogMCwgY2xhc3M6ICJ0ZWFtLXNsaWRlciIgfSwKICAvLyAgICAgICAgICB7IG5hbWU6ICJJbnZlc3RvciIsIHByb3A6IDAsIGNsYXNzOiAiaW52ZXN0b3Itc2xpZGVyIiB9LAogIC8vICAgICAgICAgIHsgbmFtZTogIkFkdmlzb3IiLCBwcm9wOiAwLCBjbGFzczogImFkdmlzb3Itc2xpZGVyIiB9LAogIC8vICAgICAgICAgIHsgbmFtZTogIkZvdW5kYXRpb24iLCBwcm9wOiAwLCBjbGFzczogImZvdW5kYXRpb24tc2xpZGVyIiB9LAogIC8vICAgICAgICAgIHsgbmFtZTogIkNvbW11bml0eSIsIHByb3A6IDAsIGNsYXNzOiAiY29tbXVuaXR5LXNsaWRlciIgfSwKICAvLyAgICAgIF0sCiAgZnVuY3Rpb24gVW5zdGFrZShsYWJlbCwgY29vbFRpbWUsIHVuc3Rha2VBbW91bnQpIHsKICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBVbnN0YWtlKTsKCiAgICAvLyBsYWJlbDog55So5oi35Zyo5YmN56uv5Lqk5LqS6aG16Z2i5Li66IqC54K56Ieq5a6a5LmJ55qE5ZCN5a2XCiAgICB0aGlzLmxhYmVsID0gbGFiZWw7IC8vIGNvb2xUaW1lOiB1bnN0YWtlIOaTjeS9nOaJp+ihjOWQjueahOmUgeS7k+aXtumXtAoKICAgIHRoaXMuY29vbFRpbWUgPSBOdW1iZXIoY29vbFRpbWUpOyAvLyB1bnN0YWtlQW1vdW50OiB1bnN0YWtlIOino+mZpOi0qOaKvOeahOaVsOmHjyjku6Xnmb7liIbmr5TnmoTlvaLlvI8pCiAgICAvLyBFeGFtcGxlOiB7IlRlYW0iOiAwLjEsICJDb21tdW5pdHkiOiAwLjJ9CgogICAgdGhpcy51bnN0YWtlQW1vdW50ID0gbmV3IE1hcCgpOyAvLyB1bnN0YWtlSGlzdG9yeTogdW5zdGFrZSDplIHku5PljZXnmoTorrDlvZXvvIzlvZPplIHku5Pml7bpl7Tnu5PmnZ/ml7bvvIzku47orrDlvZXkuK3ojrflj5blj6/ku6Xph4rmlL7nmoTph48KICAgIC8vIEV4YW1wbGU6IHsxMTogeyJUZWFtIjogMTAwMCwgIkNvbW11bml0eSI6IDIwMDB9fQoKICAgIHRoaXMudW5zdGFrZUhpc3RvcnkgPSBuZXcgTWFwKCk7CiAgICB1bnN0YWtlQW1vdW50LmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgX3RoaXMzLnVuc3Rha2VBbW91bnQuc2V0KGVsZW1lbnQubmFtZSwgTnVtYmVyKGVsZW1lbnQucHJvcCkgLyAxMDApOwogICAgfSk7CiAgfSAvLyDmiafooYzmtYvnrpfpgLvovpEKCgogIF9jcmVhdGVDbGFzcyhVbnN0YWtlLCBbewogICAga2V5OiAicnVuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBydW4ocHJlTm9kZSwgY3VyRGF5KSB7CiAgICAgIC8vIOWmguaenOayoeacieWJjeW6j+iKgueCue+8jOWImeS4jeS8muaJp+ihjOa1i+eul+mAu+i+kQogICAgICBpZiAocHJlTm9kZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vICBUT0RPOiDogIPomZHku4DkuYjmg4XlhrXkuIsgdW5zdGFrZSDnmoRydW7lh73mlbDlj6/ku6Xot7Pov4fvvJ91bnN0YWtlQW1vdW50IOS4uiAw55qE5pe25YCZ77yfCiAgICAgIC8vIGlmIChjb25kaXRpb24pIHsKICAgICAgLy8gICAgIHJldHVybiA7CiAgICAgIC8vIH0KCgogICAgICBpZiAocHJlTm9kZS5jb25zdHJ1Y3RvciA9PT0gVG9rZW4pIHsKICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpwcmUgTm9kZSBpczogIiwgcHJlTm9kZS5zeW1ib2wpOwogICAgICAgIHZhciB1blN0YWtlUmVjb3JkID0gbmV3IE1hcCgpOwoKICAgICAgICB2YXIgX2l0ZXJhdG9yNCA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMudW5zdGFrZUFtb3VudCksCiAgICAgICAgICAgIF9zdGVwNDsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZvciAoX2l0ZXJhdG9yNC5zKCk7ICEoX3N0ZXA0ID0gX2l0ZXJhdG9yNC5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgIHZhciBfaXRlbTIgPSBfc3RlcDQudmFsdWU7CiAgICAgICAgICAgIHZhciBhbW91bnQgPSBTdGFuZGFyZE51bShwcmVOb2RlLnN0YWtlZEFtb3VudC5nZXQoX2l0ZW0yWzBdKSAqIF9pdGVtMlsxXSk7IC8vIOWmguaenOW9k+WJjeWPguS4juaWuSB1bnN0YWtlIOeahCA8PSAgMO+8jOi3s+i/hwoKICAgICAgICAgICAgaWYgKGFtb3VudCA8PSAwLjApIHsKICAgICAgICAgICAgICAvLyB1blN0YWtlUmVjb3JkLnNldChpdGVtWzBdLCBOdW1iZXIoMCkpOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3Rha2VEZWx0YSA9IHByZU5vZGUuc3Rha2VkQW1vdW50RGVsdGEuZ2V0KF9pdGVtMlswXSkgLSBhbW91bnQ7CiAgICAgICAgICAgIHByZU5vZGUuc3Rha2VkQW1vdW50RGVsdGEuc2V0KF9pdGVtMlswXSwgc3Rha2VEZWx0YSk7CiAgICAgICAgICAgIHVuU3Rha2VSZWNvcmQuc2V0KF9pdGVtMlswXSwgYW1vdW50KTsKICAgICAgICAgIH0gLy8g5b2TIHVuU3Rha2VSZWNvcmQg6K6w5b2V6YeM5pyJ5YaF5a655pe277yM5o+S5YWl5YiwIHVuc3Rha2VIaXN0b3J5IOS4rQoKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIF9pdGVyYXRvcjQuZShlcnIpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBfaXRlcmF0b3I0LmYoKTsKICAgICAgICB9CgogICAgICAgIGlmICh1blN0YWtlUmVjb3JkLnNpemUgPiAwKSB7CiAgICAgICAgICB2YXIgX2l0ZXJhdG9yNSA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHVuU3Rha2VSZWNvcmQpLAogICAgICAgICAgICAgIF9zdGVwNTsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjUucygpOyAhKF9zdGVwNSA9IF9pdGVyYXRvcjUubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBpdGVtID0gX3N0ZXA1LnZhbHVlOwoKICAgICAgICAgICAgICBpZiAoIXRoaXMudW5zdGFrZUhpc3RvcnkuaGFzKGN1ckRheSArIHRoaXMuY29vbFRpbWUpKSB7CiAgICAgICAgICAgICAgICAvLyDkuLrku4DkuYjpnIDopoHlkITlj4LkuI7ogIXnmoTmlbDlgLzliJ3lp4vljJbkuLow77yf5Zug5Li6IGFudHYg5pWw5o2u5Y+v6KeG5YyW5pWI5p6c6ZyA6KaBCiAgICAgICAgICAgICAgICB0aGlzLnVuc3Rha2VIaXN0b3J5LnNldChjdXJEYXkgKyB0aGlzLmNvb2xUaW1lLCBtYXBJbml0KHRoaXMudW5zdGFrZUFtb3VudC5rZXlzKCkpKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBvbGQgPSB0aGlzLnVuc3Rha2VIaXN0b3J5LmdldChjdXJEYXkgKyB0aGlzLmNvb2xUaW1lKS5nZXQoaXRlbVswXSk7CiAgICAgICAgICAgICAgaWYgKG9sZCA9PSB1bmRlZmluZWQpIG9sZCA9IE51bWJlcigwKTsKICAgICAgICAgICAgICBvbGQgKz0gaXRlbVsxXTsgLy8gVE9ETyAoeHVmZWkpIGl0ZW1bMV0g5o2i5oiQIG9sZO+8nwoKICAgICAgICAgICAgICB0aGlzLnVuc3Rha2VIaXN0b3J5LmdldChjdXJEYXkgKyB0aGlzLmNvb2xUaW1lKS5zZXQoaXRlbVswXSwgb2xkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIF9pdGVyYXRvcjUuZShlcnIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgX2l0ZXJhdG9yNS5mKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHByZU5vZGUuY29uc3RydWN0b3IgPT09IFN0YWtlKSB7CiAgICAgICAgY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6cHJlIE5vZGUgaXM6ICIsIHByZU5vZGUubGFiZWwpOwogICAgICB9IGVsc2UgaWYgKHByZU5vZGUuY29uc3RydWN0b3IgPT09IFZlc3QpIHsKICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpwcmUgTm9kZSBpczogIiwgcHJlTm9kZS5sYWJlbCk7CiAgICAgIH0gZWxzZSBpZiAocHJlTm9kZS5jb25zdHJ1Y3RvciA9PT0gVW5zdGFrZSkgewogICAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6OnByZSBOb2RlIGlzOiAiLCBwcmVOb2RlLmxhYmVsKTsKICAgICAgfQogICAgfSAvLyDmiafooYwgRGVsdGEg5pWw5o2u5YiwIENvbW1pdCDmlbDmja7nmoTmm7TmlrAKCiAgfSwgewogICAga2V5OiAidXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6IHVuc3Rha2UgSGlzdG9yeTogIiwgdGhpcy51bnN0YWtlSGlzdG9yeSk7CiAgICB9IC8vIOW9k+aooeWei+S7juaaguWBnOeKtuaAgemHjeaWsOWQr+WKqOa1i+eul+aXtu+8jOeUqOaIt+WPr+iDveWvueWPguaVsOi/m+ihjOS6huS/ruaUue+8jOaWsOeahOWPguaVsOmcgOimgeabtOaWsOWIsOaooeWei+S4rQogICAgLy8g5pu05paw5bey5a2Y5Zyo55qEIFVuc3Rha2Ug5a6e5L6L6YeM55qE5Y+C5pWwCgogIH0sIHsKICAgIGtleTogInNlbGZVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbGZVcGRhdGUobGFiZWwsIGNvb2xUaW1lLCB1bnN0YWtlQW1vdW50KSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgdGhpcy5sYWJlbCA9IGxhYmVsOwogICAgICB0aGlzLmNvb2xUaW1lID0gTnVtYmVyKGNvb2xUaW1lKTsKICAgICAgdW5zdGFrZUFtb3VudC5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgX3RoaXM0LnVuc3Rha2VBbW91bnQuc2V0KGVsZW1lbnQubmFtZSwgTnVtYmVyKGVsZW1lbnQucHJvcCkgLyAxMDApOwogICAgICB9KTsKICAgIH0KICB9XSk7CgogIHJldHVybiBVbnN0YWtlOwp9KCk7CmV4cG9ydCB2YXIgVmVzdCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgLy8gY29uc3RydWN0b3IKICAvLyBwYXJhbXM6CiAgLy8gICAgICB2ZXN0QW1vdW50OiBbCiAgLy8gICAgICAgICAgewogIC8vICAgICAgICAgICAgICBuYW1lOiAiVGVhbSIsCiAgLy8gICAgICAgICAgICAgIHByb3A6IDAsCiAgLy8gICAgICAgICAgICAgIGNsYXNzOiAidGVhbS1zbGlkZXIiLAogIC8vICAgICAgICAgICAgICBsb2NrVXBUaW1lOiAwLAogIC8vICAgICAgICAgICAgICByZWxlYXNlUGVyaW9kOiAwLAogIC8vICAgICAgICAgICAgICBjbGlmZjogMCwKICAvLyAgICAgICAgICB9LAogIC8vICAgICAgICAgIHsKICAvLyAgICAgICAgICAgICAgbmFtZTogIkludmVzdG9yIiwKICAvLyAgICAgICAgICAgICAgcHJvcDogMCwKICAvLyAgICAgICAgICAgICAgY2xhc3M6ICJpbnZlc3Rvci1zbGlkZXIiLAogIC8vICAgICAgICAgICAgICBsb2NrVXBUaW1lOiAwLAogIC8vICAgICAgICAgICAgICByZWxlYXNlUGVyaW9kOiAwLAogIC8vICAgICAgICAgICAgICBjbGlmZjogMCwKICAvLyAgICAgICAgICB9LAogIC8vICAgICAgICAgIHsKICAvLyAgICAgICAgICAgICAgbmFtZTogIkFkdmlzb3IiLAogIC8vICAgICAgICAgICAgICBwcm9wOiAwLAogIC8vICAgICAgICAgICAgICBjbGFzczogImFkdmlzb3Itc2xpZGVyIiwKICAvLyAgICAgICAgICAgICAgbG9ja1VwVGltZTogMCwKICAvLyAgICAgICAgICAgICAgcmVsZWFzZVBlcmlvZDogMCwKICAvLyAgICAgICAgICAgICAgY2xpZmY6IDAsCiAgLy8gICAgICAgICAgfSwKICAvLyAgICAgICAgICB7CiAgLy8gICAgICAgICAgICAgIG5hbWU6ICJGb3VuZGF0aW9uIiwKICAvLyAgICAgICAgICAgICAgcHJvcDogMCwKICAvLyAgICAgICAgICAgICAgY2xhc3M6ICJmb3VuZGF0aW9uLXNsaWRlciIsCiAgLy8gICAgICAgICAgICAgIGxvY2tVcFRpbWU6IDAsCiAgLy8gICAgICAgICAgICAgIHJlbGVhc2VQZXJpb2Q6IDAsCiAgLy8gICAgICAgICAgICAgIGNsaWZmOiAwLAogIC8vICAgICAgICAgIH0sCiAgLy8gICAgICAgICAgewogIC8vICAgICAgICAgICAgICBuYW1lOiAiQ29tbXVuaXR5IiwKICAvLyAgICAgICAgICAgICAgcHJvcDogMCwKICAvLyAgICAgICAgICAgICAgY2xhc3M6ICJjb21tdW5pdHktc2xpZGVyIiwKICAvLyAgICAgICAgICAgICAgbG9ja1VwVGltZTogMCwKICAvLyAgICAgICAgICAgICAgcmVsZWFzZVBlcmlvZDogMCwKICAvLyAgICAgICAgICAgICAgY2xpZmY6IDAsCiAgLy8gICAgICAgICAgfSwKICAvLyAgICAgIF0sCiAgZnVuY3Rpb24gVmVzdChsYWJlbCwgdmVzdEFtb3VudCkgewogICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFZlc3QpOwoKICAgIC8vIGxhYmVsOiDnlKjmiLflnKjliY3nq6/kuqTkupLpobXpnaLkuLroioLngrnoh6rlrprkuYnnmoTlkI3lrZcKICAgIHRoaXMubGFiZWwgPSBsYWJlbDsgLy8gdmVzdEhpc3Rvcnk6IHZlc3Qg6ZSB5LuT5Y2V55qE6K6w5b2V77yM5b2T6ZSB5LuT5pe26Ze057uT5p2f5pe277yM5LuO6K6w5b2V5Lit6I635Y+W5Y+v5Lul6YeK5pS+55qE6YePCiAgICAvLyBFeGFtcGxlOiB7MTgxOiB7IlRlYW0iOiAxMDAwMCwgIkNvbW11bml0eSI6IDQwMDAwfX0KCiAgICB0aGlzLnZlc3RIaXN0b3J5ID0gbmV3IE1hcCgpOyAvLyB2ZXN0QW1vdW50OiB2ZXN0IOmUgeS7k+eahOaVsOmHjyjku6Xnmb7liIbmr5TnmoTlvaLlvI8pCiAgICAvLyBFeGFtcGxlOiB7IlRlYW0iOiAxLjAsICJDb21tdW5pdHkiOiAxLjB9CgogICAgdGhpcy52ZXN0QW1vdW50ID0gbmV3IE1hcCgpOyAvLyB2ZXN0UG9saWN5OiB2ZXN0IOmUgeS7k+eahOetlueVpQogICAgLy8gRXhhbXBsZTogeyJUZWFtIjoge2xvY2t1cFRpbWU6IDE4MCwgcmVsZWFzZVBlcmlvZDogMzAsIGNsaWZmOiAzMH19CgogICAgdGhpcy52ZXN0UG9saWN5ID0gbmV3IE1hcCgpOwogICAgdmVzdEFtb3VudC5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgIF90aGlzNS52ZXN0QW1vdW50LnNldChlbGVtZW50Lm5hbWUsIE51bWJlcihlbGVtZW50LnByb3ApIC8gMTAwKTsKCiAgICAgIF90aGlzNS52ZXN0UG9saWN5LnNldChlbGVtZW50Lm5hbWUsIHsKICAgICAgICBsb2NrdXBUaW1lOiBOdW1iZXIoZWxlbWVudC5sb2NrVXBUaW1lKSwKICAgICAgICByZWxlYXNlUGVyaW9kOiBOdW1iZXIoZWxlbWVudC5yZWxlYXNlUGVyaW9kKSwKICAgICAgICBjbGlmZjogTnVtYmVyKGVsZW1lbnQuY2xpZmYpCiAgICAgIH0pOwogICAgfSk7CiAgfSAvLyDmiafooYzmtYvnrpfpgLvovpEKCgogIF9jcmVhdGVDbGFzcyhWZXN0LCBbewogICAga2V5OiAicnVuIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBydW4ocHJlTm9kZSwgY3VyRGF5KSB7CiAgICAgIC8vIOWmguaenOayoeacieWJjeW6j+iKgueCue+8jOWImeS4jeS8muaJp+ihjOa1i+eul+mAu+i+kQogICAgICBpZiAocHJlTm9kZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vICBUT0RPOiDogIPomZHku4DkuYjmg4XlhrXkuIsgdmVzdCDnmoRydW7lh73mlbDlj6/ku6Xot7Pov4fvvJ92ZXN0QW1vdW50IOS4uiAw55qE5pe25YCZ77yfCiAgICAgIC8vIGlmIChjb25kaXRpb24pIHsKICAgICAgLy8gICAgIHJldHVybiA7CiAgICAgIC8vIH0KCgogICAgICBpZiAocHJlTm9kZS5jb25zdHJ1Y3RvciA9PT0gVG9rZW4pIHsKICAgICAgICB2YXIgdmVzdFJlY29yZCA9IG5ldyBNYXAoKTsKCiAgICAgICAgaWYgKHByZU5vZGUudG90YWxTdXBwbHkgPiAwICYmIHByZU5vZGUuY2FuVmVzdCA9PSAxKSB7CiAgICAgICAgICAvLyDlr7nkuo7pobnnm67lj5HooYzku6PluIHvvIx2ZXN0IOeahOWvueixoeaYr+WIneWni+WIhumFjeeahOW4gemHjwogICAgICAgICAgdmFyIF9pdGVyYXRvcjYgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih0aGlzLnZlc3RBbW91bnQpLAogICAgICAgICAgICAgIF9zdGVwNjsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjYucygpOyAhKF9zdGVwNiA9IF9pdGVyYXRvcjYubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBpdGVtID0gX3N0ZXA2LnZhbHVlOwogICAgICAgICAgICAgIHZhciBhbW91bnQgPSBTdGFuZGFyZE51bSgocHJlTm9kZS5hbGxvY2F0aW9uUGVyY2VudC5nZXQoaXRlbVswXSkgKiBwcmVOb2RlLnRvdGFsU3VwcGx5IC0gcHJlTm9kZS5hbGxvY2F0ZWRBbW91bnQuZ2V0KGl0ZW1bMF0pKSAqIGl0ZW1bMV0pOyAvLyDlr7nkuo4gYW1vdW50IDw9IDAg55qE5oOF5Ya177yM5LiN5o+S5YWl5YiwIHZlc3RSZWNvcmQg6YeMCgogICAgICAgICAgICAgIGlmIChhbW91bnQgPD0gMC4wKSB7CiAgICAgICAgICAgICAgICAvLyB2ZXN0UmVjb3JkLnNldChpdGVtWzBdLCBOdW1iZXIoMCkpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwcmVOb2RlLmFsbG9jYXRlZEFtb3VudERlbHRhLnNldChpdGVtWzBdLCBwcmVOb2RlLmFsbG9jYXRlZEFtb3VudERlbHRhLmdldChpdGVtWzBdKSArIGFtb3VudCk7CiAgICAgICAgICAgICAgdmVzdFJlY29yZC5zZXQoaXRlbVswXSwgYW1vdW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIF9pdGVyYXRvcjYuZShlcnIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgX2l0ZXJhdG9yNi5mKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChwcmVOb2RlLnRvdGFsU3VwcGx5IDw9IDApIHsKICAgICAgICAgIC8vIOWvueS6jumdnumhueebruWPkeihjOS7o+W4ge+8jHZlc3Qg55qE5a+56LGh5Y+v6IO95pivIGZyZWVNb25leSDpg6jliIYKICAgICAgICAgIHZhciBfaXRlcmF0b3I3ID0gX2NyZWF0ZUZvck9mSXRlcmF0b3JIZWxwZXIodGhpcy52ZXN0QW1vdW50KSwKICAgICAgICAgICAgICBfc3RlcDc7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yIChfaXRlcmF0b3I3LnMoKTsgIShfc3RlcDcgPSBfaXRlcmF0b3I3Lm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgICB2YXIgX2l0ZW0zID0gX3N0ZXA3LnZhbHVlOwoKICAgICAgICAgICAgICB2YXIgX2Ftb3VudCA9IFN0YW5kYXJkTnVtKHByZU5vZGUuZnJlZU1vbmV5LmdldChfaXRlbTNbMF0pICogX2l0ZW0zWzFdKTsgLy8g5a+55LqOIGFtb3VudCA8PSAwIOeahOaDheWGte+8jOS4jeaPkuWFpeWIsCB2ZXN0UmVjb3JkIOmHjAoKCiAgICAgICAgICAgICAgaWYgKF9hbW91bnQgPD0gMC4wKSB7CiAgICAgICAgICAgICAgICAvLyB2ZXN0UmVjb3JkLnNldChpdGVtWzBdLCBOdW1iZXIoMCkpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwcmVOb2RlLmZyZWVNb25leURlbHRhLnNldChfaXRlbTNbMF0sIHByZU5vZGUuZnJlZU1vbmV5RGVsdGEuZ2V0KF9pdGVtM1swXSkgLSBfYW1vdW50KTsKICAgICAgICAgICAgICB2ZXN0UmVjb3JkLnNldChfaXRlbTNbMF0sIF9hbW91bnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgX2l0ZXJhdG9yNy5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3I3LmYoKTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIOW9kyB2ZXN0UmVjb3JkIOiusOW9lemHjOacieWGheWuueaXtu+8jOaPkuWFpeWIsCB2ZXN0SGlzdG9yeSDkuK0KCgogICAgICAgIGlmICh2ZXN0UmVjb3JkLnNpemUgPiAwKSB7CiAgICAgICAgICB2YXIgX2l0ZXJhdG9yOCA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHZlc3RSZWNvcmQpLAogICAgICAgICAgICAgIF9zdGVwODsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKF9pdGVyYXRvcjgucygpOyAhKF9zdGVwOCA9IF9pdGVyYXRvcjgubigpKS5kb25lOykgewogICAgICAgICAgICAgIHZhciBfaXRlbTQgPSBfc3RlcDgudmFsdWU7CiAgICAgICAgICAgICAgLy8g57q/5oCn6YeK5pS+CiAgICAgICAgICAgICAgdmFyIHJlbGVhc2VQZXJpb2QgPSB0aGlzLnZlc3RQb2xpY3kuZ2V0KF9pdGVtNFswXSkucmVsZWFzZVBlcmlvZDsKICAgICAgICAgICAgICB2YXIgcmVsZWFzZU51bWJlciA9IE1hdGguZmxvb3IodGhpcy52ZXN0UG9saWN5LmdldChfaXRlbTRbMF0pLmxvY2t1cFRpbWUgLyByZWxlYXNlUGVyaW9kKTsKICAgICAgICAgICAgICB2YXIgY2xpZmYgPSB0aGlzLnZlc3RQb2xpY3kuZ2V0KF9pdGVtNFswXSkuY2xpZmY7CiAgICAgICAgICAgICAgaWYgKGNsaWZmID09IDApIHJlbGVhc2VOdW1iZXIrKzsKICAgICAgICAgICAgICB2YXIgcmVsZWFzZUFtb3VudCA9IFN0YW5kYXJkTnVtKF9pdGVtNFsxXSAvIHJlbGVhc2VOdW1iZXIpOwoKICAgICAgICAgICAgICBpZiAodGhpcy52ZXN0UG9saWN5LmdldChfaXRlbTRbMF0pLmxvY2t1cFRpbWUgPT0gMCB8fCByZWxlYXNlUGVyaW9kID09IDApIHsKICAgICAgICAgICAgICAgIHJlbGVhc2VOdW1iZXIgPSAxOwogICAgICAgICAgICAgICAgcmVsZWFzZUFtb3VudCA9IF9pdGVtNFsxXTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVsZWFzZU51bWJlcjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyDlpoLmnpwgdmVzdEhpc3Rvcnkg6YeM5rKh5pyJIGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2Qg55qE6K6w5b2V5pe277yM5Yid5aeL5YyWCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudmVzdEhpc3RvcnkuaGFzKGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2QpKSB7CiAgICAgICAgICAgICAgICAgIC8vIOS4uuS7gOS5iOmcgOimgeWQhOWPguS4juiAheeahOaVsOWAvOWIneWni+WMluS4ujDvvJ/lm6DkuLogYW50diDmlbDmja7lj6/op4bljJbmlYjmnpzpnIDopoEKICAgICAgICAgICAgICAgICAgdGhpcy52ZXN0SGlzdG9yeS5zZXQoY3VyRGF5ICsgY2xpZmYgKyBpICogcmVsZWFzZVBlcmlvZCwgbWFwSW5pdCh0aGlzLnZlc3RBbW91bnQua2V5cygpKSk7CiAgICAgICAgICAgICAgICB9IC8vIOWwhui/measoeiuoeeul+mcgOimgemAmui/hyB2ZXN0IOmHiuaUvueahCBhbW91bnQg57Sv5Yqg5Yiw5Y6G5Y+y5pWw5o2u5LiKCgoKICAgICAgICAgICAgICAgIHZhciBvbGQgPSB0aGlzLnZlc3RIaXN0b3J5LmdldChjdXJEYXkgKyBjbGlmZiArIGkgKiByZWxlYXNlUGVyaW9kKTsKICAgICAgICAgICAgICAgIG9sZC5zZXQoX2l0ZW00WzBdLCAob2xkLmdldChfaXRlbTRbMF0pID09IHVuZGVmaW5lZCA/IDAgOiBvbGQuZ2V0KF9pdGVtNFswXSkpICsgcmVsZWFzZUFtb3VudCk7CiAgICAgICAgICAgICAgICB0aGlzLnZlc3RIaXN0b3J5LnNldChjdXJEYXkgKyBjbGlmZiArIGkgKiByZWxlYXNlUGVyaW9kLCBvbGQpOwogICAgICAgICAgICAgIH0gLy8g6ICB54mI5pys5piv6L+Z5LmI5YaZ55qE77yM5q+U6L6D57mB55CQCiAgICAgICAgICAgICAgLy8g5a+55LqOIGxvY2tVcFRpbWUg5Li6IDDvvIzljbPkuI3pnIDopoHplIHku5Pnq4vljbPph4rmlL7nmoTmg4XlhrUKICAgICAgICAgICAgICAvLyBpZiAodGhpcy52ZXN0UG9saWN5LmdldChpdGVtWzBdKS5sb2NrdXBUaW1lID09IDAgJiYgY2xpZmYgPT0gMCAmJiByZWxlYXNlUGVyaW9kID09IDApIHsKICAgICAgICAgICAgICAvLyAgICAgLy8g5aaC5p6cIHZlc3RIaXN0b3J5IOmHjOayoeaciSBjdXJEYXkg55qE6K6w5b2V5pe277yM5Yid5aeL5YyWCiAgICAgICAgICAgICAgLy8gICAgIGlmICghdGhpcy52ZXN0SGlzdG9yeS5oYXMoY3VyRGF5KSkgewogICAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy52ZXN0SGlzdG9yeS5zZXQoY3VyRGF5LCBuZXcgTWFwKCkpOwogICAgICAgICAgICAgIC8vICAgICB9IAogICAgICAgICAgICAgIC8vICAgICAvLyDlsIbov5nmrKHorqHnrpfpnIDopoHpgJrov4cgdmVzdCDph4rmlL7nmoQgYW1vdW50IOe0r+WKoOWIsOWOhuWPsuaVsOaNruS4igogICAgICAgICAgICAgIC8vICAgICBsZXQgb2xkID0gdGhpcy52ZXN0SGlzdG9yeS5nZXQoY3VyRGF5KTsKICAgICAgICAgICAgICAvLyAgICAgb2xkLnNldChpdGVtWzBdLCAob2xkLmdldChpdGVtWzBdKSA9PSB1bmRlZmluZWQgPyAwIDogb2xkLmdldChpdGVtWzBdKSkgKyBpdGVtWzFdKTsKICAgICAgICAgICAgICAvLyAgICAgdGhpcy52ZXN0SGlzdG9yeS5zZXQoY3VyRGF5LCBvbGQpOwogICAgICAgICAgICAgIC8vIH0gCiAgICAgICAgICAgICAgLy8gZWxzZSB7CiAgICAgICAgICAgICAgLy8gICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVsZWFzZU51bWJlcjsgaSsrKSB7CiAgICAgICAgICAgICAgLy8gICAgICAgICAvLyDlpoLmnpwgdmVzdEhpc3Rvcnkg6YeM5rKh5pyJIGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2Qg55qE6K6w5b2V5pe277yM5Yid5aeL5YyWCiAgICAgICAgICAgICAgLy8gICAgICAgICBpZiAoIXRoaXMudmVzdEhpc3RvcnkuaGFzKGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2QpKSB7CiAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgdGhpcy52ZXN0SGlzdG9yeS5zZXQoY3VyRGF5ICsgY2xpZmYgKyBpICogcmVsZWFzZVBlcmlvZCwgbmV3IE1hcCgpKTsKICAgICAgICAgICAgICAvLyAgICAgICAgIH0gCiAgICAgICAgICAgICAgLy8gICAgICAgICAvLyDlsIbov5nmrKHorqHnrpfpnIDopoHpgJrov4cgdmVzdCDph4rmlL7nmoQgYW1vdW50IOe0r+WKoOWIsOWOhuWPsuaVsOaNruS4igogICAgICAgICAgICAgIC8vICAgICAgICAgbGV0IG9sZCA9IHRoaXMudmVzdEhpc3RvcnkuZ2V0KGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2QpOwogICAgICAgICAgICAgIC8vICAgICAgICAgb2xkLnNldChpdGVtWzBdLCAob2xkLmdldChpdGVtWzBdKSA9PSB1bmRlZmluZWQgPyAwIDogb2xkLmdldChpdGVtWzBdKSkgKyByZWxlYXNlQW1vdW50KTsKICAgICAgICAgICAgICAvLyAgICAgICAgIHRoaXMudmVzdEhpc3Rvcnkuc2V0KGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2QsIG9sZCk7CiAgICAgICAgICAgICAgLy8gICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpWZXN0OiBpbnNlcnRpbmcgdmVzdCBoaXN0b3J5OiIsIGN1ckRheSArIGNsaWZmICsgaSAqIHJlbGVhc2VQZXJpb2QsICIgLSAiLCBvbGQpOwogICAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIF9pdGVyYXRvcjguZShlcnIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgX2l0ZXJhdG9yOC5mKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHByZU5vZGUuY29uc3RydWN0b3IgPT09IFN0YWtlKSB7CiAgICAgICAgY29uc29sZS5sb2codGhpcy5sYWJlbCwgIjo6cHJlIE5vZGUgaXM6ICIsIHByZU5vZGUubGFiZWwpOwogICAgICB9IGVsc2UgaWYgKHByZU5vZGUuY29uc3RydWN0b3IgPT09IFZlc3QpIHsKICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmxhYmVsLCAiOjpwcmUgTm9kZSBpczogIiwgcHJlTm9kZS5sYWJlbCk7CiAgICAgIH0gZWxzZSBpZiAocHJlTm9kZS5jb25zdHJ1Y3RvciA9PT0gVW5zdGFrZSkgewogICAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6OnByZSBOb2RlIGlzOiAiLCBwcmVOb2RlLmxhYmVsKTsKICAgICAgfQogICAgfSAvLyDmiafooYwgRGVsdGEg5pWw5o2u5YiwIENvbW1pdCDmlbDmja7nmoTmm7TmlrAKCiAgfSwgewogICAga2V5OiAidXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFiZWwsICI6IHZlc3QgSGlzdG9yeTogIiwgdGhpcy52ZXN0SGlzdG9yeSk7CiAgICB9IC8vIOW9k+aooeWei+S7juaaguWBnOeKtuaAgemHjeaWsOWQr+WKqOa1i+eul+aXtu+8jOeUqOaIt+WPr+iDveWvueWPguaVsOi/m+ihjOS6huS/ruaUue+8jOaWsOeahOWPguaVsOmcgOimgeabtOaWsOWIsOaooeWei+S4rQogICAgLy8g5pu05paw5bey5a2Y5Zyo55qEIFZlc3Qg5a6e5L6L6YeM55qE5Y+C5pWwCgogIH0sIHsKICAgIGtleTogInNlbGZVcGRhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbGZVcGRhdGUobGFiZWwsIHZlc3RBbW91bnQpIHsKICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICB0aGlzLmxhYmVsID0gbGFiZWw7CiAgICAgIHZlc3RBbW91bnQuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgIF90aGlzNi52ZXN0QW1vdW50LnNldChlbGVtZW50Lm5hbWUsIE51bWJlcihlbGVtZW50LnByb3ApIC8gMTAwKTsKCiAgICAgICAgX3RoaXM2LnZlc3RQb2xpY3kuc2V0KGVsZW1lbnQubmFtZSwgewogICAgICAgICAgbG9ja3VwVGltZTogTnVtYmVyKGVsZW1lbnQubG9ja1VwVGltZSksCiAgICAgICAgICByZWxlYXNlUGVyaW9kOiBOdW1iZXIoZWxlbWVudC5yZWxlYXNlUGVyaW9kKSwKICAgICAgICAgIGNsaWZmOiBOdW1iZXIoZWxlbWVudC5jbGlmZikKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gVmVzdDsKfSgpOw=="},{"version":3,"sources":["/Users/xufei/Desktop/FlowModel/src/graph/action.js"],"names":["Token","pow","divide","subtract","chain","NonNegative","StandardNum","mapInit","Action","stakeLabelIDMap","Map","unstakeLabelIDMap","vestLabelIDMap","Stake","label","rewardPolicy","stakeAmount","rewardTotal","Number","rewardLifetime","rewardRefreshPeriod","rewardDefactor","rewardAllocated","rewardAllocatedDelta","rewardAllocatedTotal","rewardList","calculateRewardList","rewardIdx","forEach","element","set","name","prop","console","log","preNode","curDay","constructor","stakedAmountDelta","item","freeMoney","has","delta","get","freeMoneyDelta","stakedTotal","curReward","stakedAmount","Vest","Unstake","totalAmount","totalTime","periodTime","defactor","periodNum","dividend","divisor","releaseBase","multiply","res","i","curPeriod","Math","floor","tmp","push","coolTime","unstakeAmount","unstakeHistory","unStakeRecord","amount","stakeDelta","size","keys","old","undefined","vestAmount","vestHistory","vestPolicy","lockupTime","lockUpTime","releasePeriod","cliff","vestRecord","totalSupply","canVest","allocationPercent","allocatedAmount","allocatedAmountDelta","releaseNumber","releaseAmount"],"mappings":"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","sourcesContent":["import { Token } from \"./token\";\nimport { pow, divide, subtract, chain } from 'mathjs';\nimport { NonNegative, StandardNum } from \"../utils/numberUtil\";\nimport { mapInit } from \"../utils/mapInit\";\nexport class Action {\n\n    constructor() {\n        // stakeLabelIDMap <key: nodeLabel, value: nodeID> : stake 节点的 label(交互页面可由用户自定义的文本名) 与 id 映射表\n        this.stakeLabelIDMap = new Map();\n        // stakeLabelIDMap <key: nodeLabel, value: nodeID> : unstake 节点的 label 与 id 映射表\n        this.unstakeLabelIDMap = new Map();\n        // stakeLabelIDMap <key: nodeLabel, value: nodeID> : vest 节点的 label 与 id 映射表\n        this.vestLabelIDMap = new Map();\n    }\n}\n\nexport class Stake {\n\n    // constructor\n    // params:\n    //      stakeToken: \"Apex\",\n    //      rewardToken: \"esApex\"\n    //      rewardPolicy {\n    //          BigInt rewardTotal;\n    //          int rewardLifetime;\n    //          int rewardRefreshPeriod;\n    //          float rewardDefactor;\n    //      },\n    //      stakeAmount: [\n    //          { name: \"Team\", prop: 0, class: \"team-slider\" },\n    //          { name: \"Investor\", prop: 0, class: \"investor-slider\" },\n    //          { name: \"Advisor\", prop: 0, class: \"advisor-slider\" },\n    //          { name: \"Foundation\", prop: 0, class: \"foundation-slider\" },\n    //          { name: \"Community\", prop: 0, class: \"community-slider\" },\n    //      ],\n    // TODO rewardToken, stakeToke 是否必要？\n    constructor(label, rewardPolicy, stakeAmount) {\n        // label: 用户在前端交互页面为节点自定义的名字\n        this.label = label;\n\n        // stakeToken: stake 支持的质押币种\n        // rewardToken: stake 的质押奖励币种\n\n        // rewardTotal: stake 产生的质押奖励币总量\n        this.rewardTotal = Number(rewardPolicy.rewardTotal);\n        // rewardLifetime: stake 产生质押奖励的总时长\n        this.rewardLifetime = Number(rewardPolicy.rewardLifetime);\n        // rewardRefreshPeriod: stake 产生质押奖励的周期\n        this.rewardRefreshPeriod = Number(rewardPolicy.rewardRefreshPeriod);\n        // rewardDefactor: stake 质押奖励的衰减因子\n        this.rewardDefactor = Number(rewardPolicy.rewardDefactor);\n\n        // stakeAmount: stake 的数量(以百分比的形式)\n        // Example: {\"Team\": 0.8, \"Community\": 0.8}\n        this.stakeAmount = new Map();\n\n        // TODO inPoolAmount 相关参数暂时不需要了，因为以 Token 节点的 stakedAmount 为准\n        // inPoolAmount: stake 质押池中已经有的质押币数量\n        // Example: {\"Team\": 100, \"Community\": 100}\n        // this.inPoolAmount = new Map();\n        // inPoolAmountDelta: stake 质押池中已经有的质押币数量 增量数据\n        // this.inPoolAmountDelta = new Map();\n        // inPoolAmountTotal: stake 质押池中已有的质押币总量\n        // this.inPoolAmountTotal = 0;\n\n        // rewardAllocated: stake 已经产生的奖励分配\n        // Example: {\"Team\": 10000, \"Community\": 10000}\n        this.rewardAllocated = new Map();\n        // rewardAllocatedDelta: stake 已经产生的奖励分配 增量数据\n        this.rewardAllocatedDelta = new Map();\n        // rewardAllocatedTotal: stake 已经产生的奖励总量\n        this.rewardAllocatedTotal = Number(0);\n        // rewardList: 保存了每天可以释放的 reward 量\n        this.rewardList = this.calculateRewardList(this.rewardTotal, this.rewardLifetime, this.rewardRefreshPeriod, this.rewardDefactor);\n        // rewardIdx: 记录当前奖励释放的进度\n        this.rewardIdx = Number(0);\n\n        stakeAmount.forEach(element => {\n            // 获取 stakeAmount 数据\n            this.stakeAmount.set(element.name, Number(element.prop) / 100);\n            // inPoolAmount 表示已经质押在池子里的数量\n            // this.inPoolAmount.set(element.name, 0);\n            // this.inPoolAmountDelta.set(element.name, 0);\n            // rewardAllocated 表示已经分配的收益\n            this.rewardAllocated.set(element.name, Number(0));\n            this.rewardAllocatedDelta.set(element.name, Number(0));\n        })\n\n        console.log(this.label, \"::Stake: reward total:\", this.rewardTotal);\n        \n    }\n\n    // 执行测算逻辑\n    run(preNode, curDay) {\n        // 如果没有前序节点，则不会执行测算逻辑\n        if (preNode == null) {\n            return ;\n        }\n        // 当池子的奖励计划已经结束，或者分配出去的奖励已经达到初始设置的奖励总额时，不再执行当前 stake 的测算逻辑\n        if (this.rewardIdx >= this.rewardLifetime || this.rewardAllocatedTotal >= this.rewardTotal) {\n            // log 提示 stake 已不会继续释放奖励\n            // TODO 把 stake 池子里已有的 stakedAmount 释放出去成为 freeMoney. 如何避免 Unstake 那边的操作重复取出？\n            // if (preNode.constructor === Token) {\n            //     for (let item of preNode.stakedAmount) {\n                    \n            //         if (item[1] <= 0)\n            //             continue;\n            //         // 从前序 token 节点中减去 stake 的全部数量\n            //         let stakeDelta = preNode.stakedAmountDelta.get(item[0]);\n            //         console.log(this.label, \"::Stake: stakeAmount minus:\", item[1]);\n            //         stakeDelta -= item[1];\n            //         preNode.stakedAmountDelta.set(item[0], stakeDelta);\n            //         // 往前序 token 节点的 freeMoneyDelta 加上 stake 的全部数量\n            //         let freeMoneyDelta = preNode.freeMoneyDelta.get(item[0]);\n            //         freeMoneyDelta += item[1];\n            //         preNode.freeMoneyDelta.set(item[0], freeMoneyDelta);\n            //     }\n            // }\n            return ;\n        }\n\n        if (preNode.constructor === Token) {\n            // TODO [Done, StakeAmount 统一放在 Token 节点中. Stake 和 Unstake 操作都基于 Token 节点的 StakeAmount 数据, 但还不确定存在什么问题] Stake 如何感知到 Unstake 操作的影响\n            // this.inPoolAmount = preNode.stakedAmount;\n            // this.inPoolAmountDelta = preNode.stakedAmountDelta;\n            // this.inPoolAmountTotal = preNode.stakedTotal;\n            // console.log(this.label, \"::pre Node is: \", preNode.symbol);\n\n            // 当天加入 stake 池子中的 token 量\n            for (let item of preNode.stakedAmountDelta) {\n                if (preNode.freeMoney.has(item[0])) {\n                    // TODO [Done] 如果增量数据为 0，就跳过\n                    let delta = StandardNum(preNode.freeMoney.get(item[0]) * this.stakeAmount.get(item[0]));\n                    if (delta <= 0.0)\n                        continue;\n                    item[1] += delta;\n                    // 把上述当天加入 stake 池子的 token 量累加到前序节点的 stakedAmount 上\n                    preNode.stakedAmountDelta.set(item[0], item[1]);\n                    // 把上述当天加入 stake 池子的 token 从前序节点中减去\n                    preNode.freeMoneyDelta.set(item[0], preNode.freeMoneyDelta.get(item[0]) - delta);\n                    \n                }\n                \n                // this.inPoolAmountDelta.set(item[0], item[1]);\n            }\n\n\n            // 当天 stake 池子产生的奖励量, 只有当 inPoolAmountTotal > 0 时才会有奖励分配\n            if (preNode.stakedTotal > 0) {\n                let curReward = this.rewardList[this.rewardIdx];\n                console.log(this.label,\"::Stake: curent reward:\", curReward);\n                for (let item of this.rewardAllocatedDelta) {\n                    // TODO [Done] 增量数据如果为0，就跳过\n                    let delta = StandardNum(preNode.stakedAmount.get(item[0]) / preNode.stakedTotal * curReward);\n                    if (delta <= 0.0)\n                        continue;\n                    item[1] += delta;\n    \n                    this.rewardAllocatedDelta.set(item[0], item[1]);\n                }\n\n                this.rewardIdx++;\n            }\n            \n        } else if (preNode.constructor === Stake) {\n            console.log(this.label, \"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Vest) {\n            console.log(this.label, \"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Unstake) {\n            console.log(this.label, \"::pre Node is: \", preNode.label);\n        }\n    }\n\n    // 执行 Delta 数据到 Commit 数据的更新\n    update() {\n\n        // for (let item of this.inPoolAmount) {\n        //     item[1] += this.inPoolAmountDelta.get(item[0]);\n        //     this.inPoolAmount.set(item[0], item[1]);\n        //     this.inPoolAmountTotal += this.inPoolAmountDelta.get(item[0]);\n        //     this.inPoolAmountDelta.set(item[0], 0);\n        // }\n\n        for (let item of this.rewardAllocated) {\n            item[1] = NonNegative(item[1] + this.rewardAllocatedDelta.get(item[0]));\n            this.rewardAllocated.set(item[0], Number(item[1]));\n            this.rewardAllocatedTotal = NonNegative(this.rewardAllocatedTotal + this.rewardAllocatedDelta.get(item[0]));\n            this.rewardAllocatedDelta.set(item[0], Number(0));\n        }\n\n        console.log(this.label, \"::Stake: rewardAllocated:\", this.rewardAllocated);\n        console.log(this.label, \"::Stake: rewardAllocatedDelta:\", this.rewardAllocatedDelta);\n        console.log(this.label, \"::Stake: rewardAllocatedTotal:\", this.rewardAllocatedTotal);\n    }\n\n    // 计算出当奖励总量为 totalAmount, staking奖励时长 totalTime, 奖励刷新周期为 periodTime, 每个周期奖励的衰减系数为 defactor 的情况下，完整的每天奖励量列表\n    // 例如: [1000,900,810,...], 意为第1天的奖励量为1000, 第2天的奖励量为900,...\n    calculateRewardList(totalAmount, totalTime, periodTime, defactor) {\n        // TODO [Done] corner case 的返回值需要修改为 array 类型\n        if (totalAmount == 0 ) {\n            return [0];\n        }\n        if (totalTime <= 1 ) {\n            return [totalAmount];\n        } \n        if (periodTime == 0) {\n            return [totalAmount];\n        }\n        if (defactor == 0) {\n            return [totalAmount];\n        }\n        const periodNum = divide(totalTime, periodTime);\n        const dividend = subtract(1, defactor);\n        const divisor = subtract(1, pow(defactor, periodNum));\n        let releaseBase = StandardNum(chain(totalAmount).multiply(dividend).divide(divisor));\n        if (defactor == 1.0) {\n            releaseBase = StandardNum(chain(totalAmount).divide(periodNum));\n        }\n\n        let res = [];\n        for (let i = 0;i < totalTime; i++) {\n            let curPeriod = Math.floor(i / periodTime);\n            let tmp = StandardNum(releaseBase * pow(defactor, curPeriod) / periodTime);\n            res.push(tmp);\n            \n        }\n        return res;\n    }\n\n    // 当模型从暂停状态重新启动测算时，用户可能对参数进行了修改，新的参数需要更新到模型中\n    // 更新已存在的 stake 实例里的参数\n    selfUpdate(label, rewardPolicy, stakeAmount) {\n        this.label = label;\n        // TODO 暂不支持在测算中途更改 rewardTotal，因为 rewardList 是在测算初始的时候就计算出来了\n        // this.rewardTotal = Number(rewardPolicy.rewardTotal);\n        this.rewardLifetime = Number(rewardPolicy.rewardLifetime);\n        this.rewardRefreshPeriod = Number(rewardPolicy.rewardRefreshPeriod);\n        this.rewardDefactor = Number(rewardPolicy.rewardDefactor);\n\n        stakeAmount.forEach(element => {\n            // 更新 stakeAmount 数据\n            this.stakeAmount.set(element.name, Number(element.prop) / 100);\n        })\n    }\n\n}\n\nexport class Unstake {\n\n    // constructor\n    // params:\n    //      coolTime: 180\n    //      unstakeAmount: [\n    //          { name: \"Team\", prop: 0, class: \"team-slider\" },\n    //          { name: \"Investor\", prop: 0, class: \"investor-slider\" },\n    //          { name: \"Advisor\", prop: 0, class: \"advisor-slider\" },\n    //          { name: \"Foundation\", prop: 0, class: \"foundation-slider\" },\n    //          { name: \"Community\", prop: 0, class: \"community-slider\" },\n    //      ],\n    constructor(label, coolTime, unstakeAmount) {\n        // label: 用户在前端交互页面为节点自定义的名字\n        this.label = label;\n        // coolTime: unstake 操作执行后的锁仓时间\n        this.coolTime = Number(coolTime);\n        \n        // unstakeAmount: unstake 解除质押的数量(以百分比的形式)\n        // Example: {\"Team\": 0.1, \"Community\": 0.2}\n        this.unstakeAmount = new Map();\n        // unstakeHistory: unstake 锁仓单的记录，当锁仓时间结束时，从记录中获取可以释放的量\n        // Example: {11: {\"Team\": 1000, \"Community\": 2000}}\n        this.unstakeHistory = new Map();\n\n        unstakeAmount.forEach(element => {\n            this.unstakeAmount.set(element.name, Number(element.prop) / 100);\n        })\n    }\n\n    // 执行测算逻辑\n    run(preNode, curDay) {\n        // 如果没有前序节点，则不会执行测算逻辑\n        if (preNode == null) {\n            return ;\n        }\n        //  TODO: 考虑什么情况下 unstake 的run函数可以跳过？unstakeAmount 为 0的时候？\n        // if (condition) {\n        //     return ;\n        // }\n        \n        if (preNode.constructor === Token) {\n            // console.log(this.label, \"::pre Node is: \", preNode.symbol);\n            let unStakeRecord = new Map();\n            for (let item of this.unstakeAmount) {\n                let amount = StandardNum(preNode.stakedAmount.get(item[0]) * item[1]);\n                // 如果当前参与方 unstake 的 <=  0，跳过\n                if (amount <= 0.0) {\n                    // unStakeRecord.set(item[0], Number(0));\n                    continue;\n                }\n                    \n                let stakeDelta = preNode.stakedAmountDelta.get(item[0]) - amount;\n                preNode.stakedAmountDelta.set(item[0], stakeDelta);\n                unStakeRecord.set(item[0], amount);\n            }\n\n            // 当 unStakeRecord 记录里有内容时，插入到 unstakeHistory 中\n            if(unStakeRecord.size > 0){\n                \n                for (let item of unStakeRecord) {\n                    if (!this.unstakeHistory.has(curDay + this.coolTime)) {\n                        // 为什么需要各参与者的数值初始化为0？因为 antv 数据可视化效果需要\n                        this.unstakeHistory.set(curDay + this.coolTime, mapInit(this.unstakeAmount.keys()));\n                    }\n\n                    let old = this.unstakeHistory.get(curDay + this.coolTime).get(item[0]);\n                    if (old == undefined) old = Number(0);\n                    old += item[1];\n\n                    // TODO (xufei) item[1] 换成 old？\n                    this.unstakeHistory.get(curDay + this.coolTime).set(item[0], old);\n                }\n               \n            }\n            \n            \n        } else if (preNode.constructor === Stake) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Vest) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Unstake) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n        }\n    }\n\n    // 执行 Delta 数据到 Commit 数据的更新\n    update() {\n        console.log(this.label,\": unstake History: \", this.unstakeHistory);\n    }\n\n    // 当模型从暂停状态重新启动测算时，用户可能对参数进行了修改，新的参数需要更新到模型中\n    // 更新已存在的 Unstake 实例里的参数\n    selfUpdate(label, coolTime, unstakeAmount) {\n        this.label = label;\n        this.coolTime = Number(coolTime);\n        unstakeAmount.forEach(element => {\n            this.unstakeAmount.set(element.name, Number(element.prop) / 100);\n        })\n    }\n}\n\nexport class Vest {\n\n    // constructor\n    // params:\n    //      vestAmount: [\n    //          {\n    //              name: \"Team\",\n    //              prop: 0,\n    //              class: \"team-slider\",\n    //              lockUpTime: 0,\n    //              releasePeriod: 0,\n    //              cliff: 0,\n    //          },\n    //          {\n    //              name: \"Investor\",\n    //              prop: 0,\n    //              class: \"investor-slider\",\n    //              lockUpTime: 0,\n    //              releasePeriod: 0,\n    //              cliff: 0,\n    //          },\n    //          {\n    //              name: \"Advisor\",\n    //              prop: 0,\n    //              class: \"advisor-slider\",\n    //              lockUpTime: 0,\n    //              releasePeriod: 0,\n    //              cliff: 0,\n    //          },\n    //          {\n    //              name: \"Foundation\",\n    //              prop: 0,\n    //              class: \"foundation-slider\",\n    //              lockUpTime: 0,\n    //              releasePeriod: 0,\n    //              cliff: 0,\n    //          },\n    //          {\n    //              name: \"Community\",\n    //              prop: 0,\n    //              class: \"community-slider\",\n    //              lockUpTime: 0,\n    //              releasePeriod: 0,\n    //              cliff: 0,\n    //          },\n    //      ],\n    constructor(label, vestAmount) {\n        // label: 用户在前端交互页面为节点自定义的名字\n        this.label = label;\n        // vestHistory: vest 锁仓单的记录，当锁仓时间结束时，从记录中获取可以释放的量\n        // Example: {181: {\"Team\": 10000, \"Community\": 40000}}\n        this.vestHistory = new Map();\n        // vestAmount: vest 锁仓的数量(以百分比的形式)\n        // Example: {\"Team\": 1.0, \"Community\": 1.0}\n        this.vestAmount = new Map();\n        // vestPolicy: vest 锁仓的策略\n        // Example: {\"Team\": {lockupTime: 180, releasePeriod: 30, cliff: 30}}\n        this.vestPolicy = new Map();\n\n        vestAmount.forEach(element => {\n            this.vestAmount.set(element.name, Number(element.prop) / 100);\n            this.vestPolicy.set(element.name, {lockupTime: Number(element.lockUpTime), releasePeriod: Number(element.releasePeriod), cliff: Number(element.cliff)});\n        })\n\n    }\n\n    // 执行测算逻辑\n    run(preNode, curDay) {\n        // 如果没有前序节点，则不会执行测算逻辑\n        if (preNode == null) {\n            return ;\n        }\n        //  TODO: 考虑什么情况下 vest 的run函数可以跳过？vestAmount 为 0的时候？\n        // if (condition) {\n        //     return ;\n        // }\n        \n        if (preNode.constructor === Token) {\n            let vestRecord = new Map();\n            if(preNode.totalSupply > 0 && preNode.canVest == 1) {\n                // 对于项目发行代币，vest 的对象是初始分配的币量\n                for (let item of this.vestAmount) {\n                    let amount = StandardNum((preNode.allocationPercent.get(item[0]) * preNode.totalSupply - preNode.allocatedAmount.get(item[0])) * item[1]);\n                    // 对于 amount <= 0 的情况，不插入到 vestRecord 里\n                    if (amount <= 0.0) {\n                        // vestRecord.set(item[0], Number(0));\n                        continue;\n                    }\n                        \n                    preNode.allocatedAmountDelta.set(item[0], preNode.allocatedAmountDelta.get(item[0]) + amount);\n\n                    vestRecord.set(item[0], amount);\n                }\n                \n            } else if (preNode.totalSupply <= 0 ) {\n                // 对于非项目发行代币，vest 的对象可能是 freeMoney 部分\n                for (let item of this.vestAmount) {\n                    let amount = StandardNum(preNode.freeMoney.get(item[0]) * item[1]);\n                    // 对于 amount <= 0 的情况，不插入到 vestRecord 里\n                    if (amount <= 0.0) {\n                        // vestRecord.set(item[0], Number(0));\n                        continue;\n                    }\n                        \n                    preNode.freeMoneyDelta.set(item[0], preNode.freeMoneyDelta.get(item[0]) - amount);\n                    vestRecord.set(item[0], amount);\n                }\n               \n            }\n            // 当 vestRecord 记录里有内容时，插入到 vestHistory 中\n            if(vestRecord.size > 0){\n\n                for (let item of vestRecord) {\n                    // 线性释放\n                    let releasePeriod = this.vestPolicy.get(item[0]).releasePeriod;\n                    let releaseNumber = Math.floor(this.vestPolicy.get(item[0]).lockupTime / releasePeriod);\n                    let cliff = this.vestPolicy.get(item[0]).cliff;\n                    if (cliff == 0) releaseNumber++;\n                    let releaseAmount = StandardNum(item[1] / releaseNumber);\n                    \n                    if (this.vestPolicy.get(item[0]).lockupTime == 0 || releasePeriod == 0 ) {\n                        releaseNumber = 1;\n                        releaseAmount = item[1];\n                    }\n\n                    for (let i = 0; i < releaseNumber; i++) {\n                        // 如果 vestHistory 里没有 curDay + cliff + i * releasePeriod 的记录时，初始化\n                        if (!this.vestHistory.has(curDay + cliff + i * releasePeriod)) {\n                            // 为什么需要各参与者的数值初始化为0？因为 antv 数据可视化效果需要\n                            this.vestHistory.set(curDay + cliff + i * releasePeriod, mapInit(this.vestAmount.keys()));\n                        } \n                        // 将这次计算需要通过 vest 释放的 amount 累加到历史数据上\n                        let old = this.vestHistory.get(curDay + cliff + i * releasePeriod);\n                        old.set(item[0], (old.get(item[0]) == undefined ? 0 : old.get(item[0])) + releaseAmount);\n                        this.vestHistory.set(curDay + cliff + i * releasePeriod, old);\n                    }\n\n                    // 老版本是这么写的，比较繁琐\n                    // 对于 lockUpTime 为 0，即不需要锁仓立即释放的情况\n                    // if (this.vestPolicy.get(item[0]).lockupTime == 0 && cliff == 0 && releasePeriod == 0) {\n                    //     // 如果 vestHistory 里没有 curDay 的记录时，初始化\n                    //     if (!this.vestHistory.has(curDay)) {\n                    //         this.vestHistory.set(curDay, new Map());\n                    //     } \n                    //     // 将这次计算需要通过 vest 释放的 amount 累加到历史数据上\n                    //     let old = this.vestHistory.get(curDay);\n                    //     old.set(item[0], (old.get(item[0]) == undefined ? 0 : old.get(item[0])) + item[1]);\n                    //     this.vestHistory.set(curDay, old);\n                    // } \n                    // else {\n                    //     for (let i = 0; i < releaseNumber; i++) {\n                    //         // 如果 vestHistory 里没有 curDay + cliff + i * releasePeriod 的记录时，初始化\n                    //         if (!this.vestHistory.has(curDay + cliff + i * releasePeriod)) {\n                    //             this.vestHistory.set(curDay + cliff + i * releasePeriod, new Map());\n                    //         } \n                    //         // 将这次计算需要通过 vest 释放的 amount 累加到历史数据上\n                    //         let old = this.vestHistory.get(curDay + cliff + i * releasePeriod);\n                    //         old.set(item[0], (old.get(item[0]) == undefined ? 0 : old.get(item[0])) + releaseAmount);\n                    //         this.vestHistory.set(curDay + cliff + i * releasePeriod, old);\n                    //         // console.log(this.label, \"::Vest: inserting vest history:\", curDay + cliff + i * releasePeriod, \" - \", old);\n                    //     }\n                    // }\n                    \n                }\n                \n            }\n            \n        } else if (preNode.constructor === Stake) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Vest) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n\n        } else if (preNode.constructor === Unstake) {\n            console.log(this.label,\"::pre Node is: \", preNode.label);\n        }\n\n    }\n\n    // 执行 Delta 数据到 Commit 数据的更新\n    update() {\n        console.log(this.label,\": vest History: \", this.vestHistory);\n    }\n\n    // 当模型从暂停状态重新启动测算时，用户可能对参数进行了修改，新的参数需要更新到模型中\n    // 更新已存在的 Vest 实例里的参数\n    selfUpdate(label, vestAmount) {\n        this.label = label;\n        vestAmount.forEach(element => {\n            this.vestAmount.set(element.name, Number(element.prop) / 100);\n            this.vestPolicy.set(element.name, {lockupTime: Number(element.lockUpTime), releasePeriod: Number(element.releasePeriod), cliff: Number(element.cliff)});\n        })\n\n    }\n}\n"]}]}